# Pixel Dungeon 프로젝트 가이드라인

## 최우선 규칙: 사용자 확인 후 워크플로우 진입

**모든 요청에 대해 먼저 YES/NO 확인 후 진행**

### 진입 확인 (필수)

모든 요청에 대해 다음을 먼저 물어봅니다:

```
📋 요청 분석: [사용자 요청 요약]

개발 워크플로우(IPE + GAPEVI)를 시작할까요?
- YES: 코드 분석 → 작업 제안 → 승인 후 구현
- NO: 간단히 답변/설명만 제공
```

### 예외 (확인 생략)

- 슬래시 명령어 (`/new-feature`, `/bugfix` 등) → 직접 실행
- 명시적 지시 ("바로 해", "확인 없이 진행") → 직접 실행

### 필수 절차: 3단계 확인 워크플로우 (IPE)

**Interpret → Present → Execute** 패턴으로 모호한 요청도 정확하게 처리합니다.

**디버그 출력 (필수):**
- 시작: `[IPE:START] 워크플로우 시작 - {요청 요약}`
- 종료: `[IPE:END] 워크플로우 완료 - {결과 요약}`

```
┌─────────────────────────────────────────────────────────────────┐
│  [IPE:START] 워크플로우 시작                                      │
├─────────────────────────────────────────────────────────────────┤
│  1. 해석 (Interpret)                                             │
│     [IPE:INTERPRET] 시작                                         │
│                                                                  │
│     사용자: "새로운 몬스터 추가해줘"                               │
│                    ↓                                             │
│     AI: Explore Agent로 컨텍스트 수집                            │
│         - 기존 Monster 클래스 구조 분석                           │
│         - 스프라이트/에셋 확인                                    │
│         - BattleSystem 연동 방식 파악                            │
│                                                                  │
│     ⚠️ 이 단계에서는 코드 수정 금지, 분석만 수행                   │
│     [IPE:INTERPRET] 완료                                         │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 제시 (Present)                                               │
│     [IPE:PRESENT] 시작                                           │
│                                                                  │
│     📋 요청 해석 결과                                             │
│     ├─ 현재 구조:                                                │
│     │   • Monster 클래스 분석 결과                                │
│     │   • 필요한 에셋 목록                                        │
│     │                                                            │
│     ├─ 제안 작업:                                                │
│     │   1. [높음] Monster 서브클래스 생성                         │
│     │   2. [중간] 스프라이트 에셋 생성                            │
│     │   3. [낮음] BattleScene 연동                               │
│     │                                                            │
│     └─ 예상 결과: 새 몬스터 타입 추가                             │
│                                                                  │
│     사용자 선택 요청 (AskUserQuestion)                           │
│     [IPE:PRESENT] 완료                                           │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 실행 (Execute)                                               │
│     [IPE:EXECUTE] 시작 → GAPEVI 사이클로 전환                     │
│                                                                  │
│     사용자 승인 후 GAPEVI 사이클 실행                             │
│     (IPE:Interpret 결과를 GAPEVI:Gather로 전달)                  │
│                                                                  │
│     [IPE:EXECUTE] 완료                                           │
├─────────────────────────────────────────────────────────────────┤
│  [IPE:END] 워크플로우 완료                                        │
└─────────────────────────────────────────────────────────────────┘
```

### IPE → GAPEVI 전환 매핑

```
┌─────────────────────────────────────────────────────────────────┐
│  IPE와 GAPEVI의 관계                                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  IPE:Interpret ──────→ GAPEVI:Gather + Analyze (일부)           │
│  (코드 분석)           (컨텍스트 수집 완료 상태로 시작)           │
│                                                                  │
│  IPE:Present ────────→ 사용자 확인 단계                          │
│  (작업 제안)           (GAPEVI 진입 전 승인)                     │
│                                                                  │
│  IPE:Execute ────────→ GAPEVI:Prioritize → Execute → Validate   │
│  (실행)                (Gather/Analyze 생략, 바로 우선순위 결정)  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**핵심**: IPE를 통해 이미 분석이 완료되었으므로, GAPEVI 진입 시 Gather/Analyze를 중복 수행하지 않음

---

# 성능 최적화 전략 (Performance Maximization)

## 1. 병렬 처리 (Parallel Execution)

### 독립 작업 동시 실행

```
┌─────────────────────────────────────────────────────────────────┐
│  병렬 처리 가능한 작업                                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  IPE:Interpret 단계                                              │
│  ┌─────────────┬─────────────┬─────────────┐                    │
│  │ 파일 탐색   │ 타입 분석   │ 의존성 분석  │  ← 병렬 실행       │
│  │ (Glob/Grep) │ (Read)      │ (Explore)   │                    │
│  └──────┬──────┴──────┬──────┴──────┬──────┘                    │
│         └─────────────┴─────────────┘                            │
│                       │                                          │
│                       ▼                                          │
│              통합 분석 결과                                       │
│                                                                  │
│  GAPEVI:Execute 단계                                             │
│  ┌─────────────┬─────────────┬─────────────┐                    │
│  │ Entity 수정 │ System 수정 │ Asset 생성  │  ← 독립 시 병렬    │
│  └─────────────┴─────────────┴─────────────┘                    │
│                                                                  │
│  GAPEVI:Validate 단계                                            │
│  ┌─────────────┬─────────────┬─────────────┐                    │
│  │ 테스트 실행 │ 타입 체크   │ 빌드        │  ← 병렬 실행       │
│  │ (npm test)  │ (tsc)       │ (vite)      │                    │
│  └─────────────┴─────────────┴─────────────┘                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 병렬 실행 규칙

| 단계 | 병렬 가능 작업 | 실행 방법 |
|------|---------------|----------|
| Gather | 다중 파일 탐색, 다중 패턴 검색 | Task Agent 다중 호출 |
| Analyze | 독립 영역 분석 (Entity/System/UI) | 병렬 Explore Agent |
| Execute | 독립 파일 수정, 에셋 생성 | 동시 Edit/Write |
| Validate | 테스트 + 타입체크 + 빌드 | 백그라운드 Bash |

**필수**: 단일 메시지에서 독립적인 도구 호출은 **항상** 병렬로 실행

```typescript
// 예시: 병렬 파일 읽기
// 단일 응답에서 여러 Read 도구를 동시에 호출
Read: Player.ts
Read: Monster.ts    // 병렬
Read: BattleSystem.ts  // 병렬
```

---

## 2. 선행 분석 (Prefetch & Lookahead)

### 예측 기반 프리로딩

```
┌─────────────────────────────────────────────────────────────────┐
│  선행 분석 전략                                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  요청: "새 몬스터 추가"                                           │
│                                                                  │
│  즉시 로드 (예측 기반):                                           │
│  ├─ src/entities/Monster.ts      (기본 클래스)                   │
│  ├─ src/types/index.ts           (타입 정의)                     │
│  ├─ src/scenes/GameScene.ts      (몬스터 배치)                   │
│  ├─ src/scenes/BattleScene.ts    (전투 연동)                     │
│  └─ scripts/generate-monster.js  (에셋 생성)                     │
│                                                                  │
│  예측 매핑:                                                       │
│  ┌──────────────┬────────────────────────────────────┐          │
│  │ 키워드       │ 선행 로드 파일                       │          │
│  ├──────────────┼────────────────────────────────────┤          │
│  │ Monster      │ Monster.ts, GameScene, BattleScene │          │
│  │ Player       │ Player.ts, InputController         │          │
│  │ 전투         │ BattleSystem, BattleScene, BattleUI│          │
│  │ UI           │ 해당 UI 파일 + Scene                │          │
│  │ 씬           │ 해당 Scene + config.ts              │          │
│  └──────────────┴────────────────────────────────────┘          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 다음 단계 예측

| 현재 단계 | 다음 단계 | 선행 준비 |
|----------|----------|----------|
| Gather 완료 | Analyze | 에이전트 선택 기준 준비 |
| Analyze 완료 | Prioritize | 작업 템플릿 준비, TodoWrite 구조화 |
| Prioritize 완료 | Execute | 수정할 파일 미리 Read |
| Execute 완료 | Validate | 백그라운드에서 테스트 시작 |

---

## 3. 캐싱 전략 (Caching & Memoization)

### 세션 내 캐싱

```
┌─────────────────────────────────────────────────────────────────┐
│  캐싱 대상                                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ✅ 캐시 사용 (재사용)                                           │
│  ├─ 파일 구조 분석 결과 (Glob/Grep 결과)                         │
│  ├─ 타입 정의 (types/index.ts)                                   │
│  ├─ 아키텍처 패턴 (이미 분석한 구조)                              │
│  └─ 이전 IPE:Interpret 결과                                      │
│                                                                  │
│  ❌ 캐시 무효화 (재분석 필요)                                     │
│  ├─ 파일 수정 후                                                 │
│  ├─ 새 파일 생성 후                                              │
│  └─ 사용자가 명시적으로 재분석 요청                               │
│                                                                  │
│  캐시 활용 예시:                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ 첫 번째 요청: "Monster 분석"                                 │ │
│  │ → Monster.ts 전체 분석, 구조 파악                            │ │
│  │                                                              │ │
│  │ 두 번째 요청: "새 몬스터 추가"                                │ │
│  │ → 이전 분석 결과 재사용, 추가 분석만 수행                     │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### IPE 결과 → GAPEVI 전달 (Zero-Copy)

```
IPE:Interpret 결과
    │
    ├─ 파일 목록 ────────────→ GAPEVI:Prioritize (재사용)
    ├─ 구조 분석 ────────────→ GAPEVI:Execute (재사용)
    └─ 의존성 맵 ────────────→ GAPEVI:Validate (재사용)

⚠️ 중복 분석 금지: IPE에서 이미 분석한 내용을 GAPEVI에서 재분석하지 않음
```

---

## 4. 조건부 최적화 (Conditional Optimization)

### 스마트 스킵 규칙

```
┌─────────────────────────────────────────────────────────────────┐
│  조건부 단계 스킵                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Gather 스킵 조건:                                               │
│  ├─ 이전 요청과 동일 영역 (5분 이내)                              │
│  ├─ 사용자가 구체적 파일 경로 제공                                │
│  └─ 단순 수정 요청 ("이 함수 수정해줘")                           │
│                                                                  │
│  Analyze 스킵 조건:                                              │
│  ├─ 단일 에이전트 명확 (키워드 100% 매칭)                         │
│  ├─ 사용자가 에이전트 명시 ("Entity Agent로 처리해")              │
│  └─ 이전 분석 결과 유효 (파일 미변경)                             │
│                                                                  │
│  Prioritize 스킵 조건:                                           │
│  ├─ 단일 파일 수정                                               │
│  ├─ 작업이 1개뿐                                                 │
│  └─ 의존성 없는 독립 작업                                        │
│                                                                  │
│  ⚠️ 절대 스킵 금지:                                              │
│  ├─ Execute (항상 실행)                                          │
│  └─ Validate (항상 검증)                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 심화 실행 조건

| 조건 | 심화 수준 | 추가 작업 |
|------|----------|----------|
| 아키텍처 변경 | 최대 | 전체 의존성 분석, 영향 범위 시뮬레이션 |
| 다중 에이전트 | 높음 | 에이전트 간 협업 계획 |
| 새 시스템 추가 | 높음 | 기존 시스템과의 통합 분석 |
| 단순 버그 수정 | 최소 | 직접 Execute → Validate |

---

## 5. 파이프라인 최적화 (Pipeline Optimization)

### 스트리밍 파이프라인

```
┌─────────────────────────────────────────────────────────────────┐
│  최적화된 파이프라인                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  기존 (순차):                                                     │
│  Gather ──완료──→ Analyze ──완료──→ Prioritize ──완료──→ ...    │
│                                                                  │
│  최적화 (스트리밍):                                               │
│  Gather ──부분결과──→ Analyze 시작                               │
│          └──────────→ 추가 수집 병렬 진행                        │
│                              │                                   │
│                              ▼                                   │
│                       Prioritize 준비                            │
│                              │                                   │
│                              ▼                                   │
│                       Execute (바로 시작)                        │
│                              │                                   │
│                              ▼                                   │
│                       Validate (백그라운드 준비)                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 백그라운드 검증

```bash
# Execute 중 백그라운드에서 Validate 준비
Execute 시작
    │
    ├─ 코드 작성 중...
    │
    └─ [백그라운드] tsc --watch 실행 (실시간 타입 체크)
       [백그라운드] 테스트 파일 감시

Execute 완료
    │
    └─ Validate 즉시 시작 (이미 준비됨)
```

---

## 6. 에이전트 최적화 (Agent Optimization)

### 에이전트 병렬 호출

```
┌─────────────────────────────────────────────────────────────────┐
│  다중 에이전트 병렬 실행                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  요청: "새 몬스터와 전투 UI 추가"                                 │
│                                                                  │
│  순차 실행 (느림):                                                │
│  Entity Agent ──완료──→ UI Agent ──완료──→ 검증                 │
│                                                                  │
│  병렬 실행 (빠름):                                                │
│  ┌─────────────────┐                                            │
│  │ Entity Agent    │ ──┐                                        │
│  │ (Monster 생성)   │   ├──→ 통합 ──→ 검증                      │
│  └─────────────────┘   │                                        │
│  ┌─────────────────┐   │                                        │
│  │ UI Agent        │ ──┘                                        │
│  │ (BattleUI 수정)  │                                            │
│  └─────────────────┘                                            │
│                                                                  │
│  병렬 가능 조건:                                                  │
│  ├─ 수정 파일이 겹치지 않음                                       │
│  ├─ 타입 의존성 없음                                              │
│  └─ 실행 순서 무관                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 에이전트 특화 최적화

| 에이전트 | 최적화 전략 |
|----------|------------|
| **Explore** | 병렬 Glob/Grep, 깊이 제한 탐색 |
| **Entity** | 베이스 클래스 캐시, 템플릿 재사용 |
| **System** | 순수 함수 우선, 테스트 먼저 작성 |
| **Scene** | 기존 씬 패턴 복제, 최소 수정 |
| **UI** | 컴포넌트 템플릿, 스타일 재사용 |
| **Tester** | 병렬 테스트 실행, 실패 시 조기 종료 |

---

## 7. 성능 지표 (Performance Metrics)

### 목표 지표

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| IPE 완료 시간 | < 30초 | 요청 → Present 까지 |
| 단일 파일 수정 | < 10초 | Analyze → Execute 완료 |
| Validate 완료 | < 60초 | 테스트 + 타입 + 빌드 |
| 전체 GAPEVI | < 3분 | 간단한 기능 추가 기준 |

### 병목 감지 및 해결

```
병목 발생 시:
├─ Gather 느림 → 검색 범위 축소, 병렬 탐색 증가
├─ Analyze 느림 → 캐시 활용, 스킵 조건 확인
├─ Execute 느림 → 파일 수 확인, 병렬 수정
└─ Validate 느림 → 백그라운드 실행, 선택적 테스트
```

---

## 프로젝트 정보

- **타입**: 픽셀 아트 던전 RPG 게임
- **엔진**: Phaser 3.90
- **언어**: TypeScript 5.9
- **빌드**: Vite 7
- **해상도**: 480x320 (픽셀 아트)
- **물리 엔진**: Arcade Physics

---

## 프로젝트 구조

```
pixel-dungeon/
├── src/
│   ├── main.ts              # 게임 진입점
│   ├── config.ts            # Phaser 게임 설정
│   ├── entities/            # 게임 엔티티
│   │   ├── Player.ts        # 플레이어 캐릭터
│   │   ├── Monster.ts       # 몬스터 기본 클래스
│   │   └── NPC.ts           # NPC 캐릭터
│   ├── scenes/              # Phaser 씬
│   │   ├── BootScene.ts     # 초기화 씬
│   │   ├── PreloadScene.ts  # 에셋 로딩 씬
│   │   ├── MenuScene.ts     # 메인 메뉴
│   │   ├── GameScene.ts     # 메인 게임플레이
│   │   └── BattleScene.ts   # 전투 씬
│   ├── systems/             # 게임 시스템
│   │   ├── InputController.ts  # 입력 처리
│   │   └── BattleSystem.ts     # 전투 로직
│   ├── ui/                  # UI 컴포넌트
│   │   ├── HealthBar.ts     # 체력바
│   │   ├── DialogBox.ts     # 대화창
│   │   └── BattleUI.ts      # 전투 UI
│   └── types/               # 타입 정의
│       └── index.ts
├── public/                  # 정적 에셋
├── scripts/                 # 에셋 생성 스크립트
│   ├── generate-player.js
│   ├── generate-monster.js
│   ├── generate-npc.js
│   └── generate-tileset.js
├── package.json
├── tsconfig.json
└── index.html
```

---

## 규칙
@./rules/typescript.md
@./rules/phaser.md
@./rules/game-architecture.md
@./rules/testing.md

## 지식 베이스
@./knowledge/conventions.md
@./knowledge/architecture.md
@./knowledge/phaser-patterns.md
@./knowledge/git-workflow.md
@./knowledge/qa-patterns.md
@./knowledge/meta-patterns.md

## 에이전트 정의
@./agents/entity.md
@./agents/scene.md
@./agents/system.md
@./agents/ui.md
@./agents/asset.md
@./agents/tester.md
@./agents/qa.md
@./agents/meta.md

## QA 문서
@./qa/README.md

## 프로젝트 추적
@../docs/ROADMAP.md
@../docs/TODO.md
@../docs/CHANGELOG.md

---

# 통합 워크플로우 (필수 준수)

## 마스터 워크플로우: GAPEVI 사이클

모든 작업은 다음 6단계 사이클을 따릅니다:

**디버그 출력 (필수):**
- 시작: `[GAPEVI:START] 사이클 시작`
- 각 단계: `[GAPEVI:{단계}] 시작/완료`
- 종료: `[GAPEVI:END] 사이클 완료 - {결과 요약}`

```
┌─────────────────────────────────────────────────────────────────────┐
│  [GAPEVI:START] 사이클 시작                                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐                      │
│   │  수집    │ → │  분석    │ → │ 우선순위  │                      │
│   │ Gather   │    │ Analyze  │    │ Prioritize│                      │
│   └──────────┘    └──────────┘    └──────────┘                      │
│                                         │                            │
│                                         ▼                            │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐                      │
│   │  반복    │ ← │  검증    │ ← │  실행    │                      │
│   │ Iterate  │    │ Validate │    │ Execute  │                      │
│   └──────────┘    └──────────┘    └──────────┘                      │
│        │                                                             │
│        └─────────────── 필요 시 해당 단계로 복귀 ──────────────────→ │
│                                                                      │
├─────────────────────────────────────────────────────────────────────┤
│  [GAPEVI:END] 사이클 완료                                            │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 단계별 상세

### 1. 수집 (Gather)
`[GAPEVI:GATHER] 시작` / `[GAPEVI:GATHER] 완료`

**목적**: 작업에 필요한 모든 정보 수집

| 활동 | 설명 |
|------|------|
| 요구사항 수집 | 사용자 요청 명확화 |
| 컨텍스트 수집 | 관련 파일, 코드 탐색 |
| 제약사항 파악 | 기술적 제한, 의존성 확인 |

**에이전트**: Explore (subagent_type="Explore")

**🚀 최적화 지침**:
| 최적화 | 적용 방법 |
|--------|----------|
| 병렬 탐색 | 다중 Glob/Grep을 단일 메시지에서 동시 호출 |
| 프리페치 | 키워드 기반 예측 파일 즉시 로드 (Monster→Monster.ts, GameScene, BattleScene) |
| 스킵 조건 | IPE:Interpret 완료 시, 동일 영역 5분 이내 재요청 시 |
| 캐시 사용 | 이전 탐색 결과 재사용, types/index.ts 캐시 |

### 2. 분석 (Analyze)
`[GAPEVI:ANALYZE] 시작` / `[GAPEVI:ANALYZE] 완료`

**목적**: 수집된 정보 분석 및 접근 방식 결정

**키워드 → 에이전트 매핑**:
| 키워드 | 에이전트 |
|--------|---------|
| Entity, Monster, Player, NPC, 캐릭터 | **Entity** |
| Scene, 씬, 화면, 전환 | **Scene** |
| System, 시스템, 전투, 입력 | **System** |
| UI, HUD, 메뉴, 대화창, 인벤토리 | **UI** |
| 에셋, 스프라이트, 타일셋, 이미지 | **Asset** |
| 테스트, 단위 테스트, 코드 검증 | **Tester** |
| QA, 품질 검증, 시나리오, 체크리스트 | **QA** |
| Agent, Command, Hook, Knowledge, Rule, 설정 | **Meta** |

**🚀 최적화 지침**:
| 최적화 | 적용 방법 |
|--------|----------|
| 즉시 결정 | 키워드 100% 매칭 시 분석 생략, 바로 에이전트 선택 |
| 병렬 분석 | 다중 영역 관련 시 여러 Explore Agent 동시 호출 |
| 스킵 조건 | 사용자가 에이전트 명시, 이전 분석 결과 유효 (파일 미변경) |
| 캐시 사용 | 아키텍처 패턴, 의존성 맵 재사용 |

### 3. 우선순위 (Prioritize)
`[GAPEVI:PRIORITIZE] 시작` / `[GAPEVI:PRIORITIZE] 완료`

**목적**: 작업 분해 및 실행 순서 결정

**작업 상태**:
- `[ ]` 대기 (Pending)
- `[~]` 진행중 (In Progress)
- `[x]` 완료 (Done)
- `[!]` 차단됨 (Blocked)

**🚀 최적화 지침**:
| 최적화 | 적용 방법 |
|--------|----------|
| 스킵 조건 | 단일 파일 수정, 작업 1개, 의존성 없는 독립 작업 |
| 병렬 그룹화 | 독립 작업 식별 → Execute에서 동시 실행 |
| 선행 Read | 수정 대상 파일 미리 읽기 (Execute 직전 프리페치) |
| TodoWrite | 간단한 작업은 생략, 3+ 작업 시만 사용 |

### 4. 실행 (Execute)
`[GAPEVI:EXECUTE] 시작` / `[GAPEVI:EXECUTE] 완료`

**목적**: 계획된 작업 구현

**게임 개발 순서**:
```
1. 타입 정의 (types/)
2. 엔티티 구현 (entities/)
3. 시스템 구현 (systems/)
4. 씬 통합 (scenes/)
5. UI 연결 (ui/)
6. 테스트 코드 작성 (*.test.ts) ← 필수!
```

**⚠️ 테스트 코드 작성 (필수)**:
- 새 기능 추가 시: 해당 로직의 단위 테스트 작성
- 버그 수정 시: 버그를 재현하는 테스트 케이스 먼저 작성, 수정 후 통과 확인
- 테스트 대상: `systems/` 순수 로직, 유틸리티 함수, 타입 가드
- Phaser 의존 코드는 모킹 또는 수동 테스트로 대체

**🚀 최적화 지침**:
| 최적화 | 적용 방법 |
|--------|----------|
| 병렬 수정 | 독립 파일 동시 Edit/Write (단일 메시지에 다중 도구 호출) |
| 에이전트 병렬 | 수정 파일 겹치지 않으면 다중 Agent 동시 실행 |
| 백그라운드 준비 | 코드 작성 중 tsc --watch 준비 (Validate 선행) |
| 스트리밍 | 파일 수정 완료 즉시 다음 파일로 진행 (순차 대기 X) |

⚠️ **절대 스킵 금지**: Execute 단계는 항상 실행해야 함

### 5. 검증 (Validate)
`[GAPEVI:VALIDATE] 시작` / `[GAPEVI:VALIDATE] 완료`

**목적**: 구현 결과 검증

**Quality Gate** (모든 항목 통과 필수):
```
┌─────────────────────────────────────────────────────────┐
│                     Quality Gate                         │
├─────────────────────────────────────────────────────────┤
│  1. 단위 테스트       npm run test                       │
│  2. 타입 체크         tsc --noEmit                       │
│  3. 린트 (ESLint)     npx eslint src/ (설정 시)          │
│  4. 빌드 (Vite)       npm run build                      │
│  5. 스모크 테스트     .claude/qa/scenarios/smoke.md      │
│  6. 영역별 테스트     해당 시나리오 (선택)                │
└─────────────────────────────────────────────────────────┘
```

**자동화 테스트 (Makefile)**:
```bash
make qa-auto    # 1-4 자동 실행
make qa         # 자동화 + 수동 테스트 안내
```

**🚀 최적화 지침**:
| 최적화 | 적용 방법 |
|--------|----------|
| 병렬 검증 | npm test + tsc --noEmit + npm run build 동시 실행 (백그라운드 Bash) |
| 조기 종료 | 첫 실패 시 나머지 검증 중단, 즉시 Iterate로 전환 |
| 선택적 테스트 | 변경 파일 관련 테스트만 우선 실행 |
| 캐시 활용 | 이전 빌드 결과 재사용 (Vite 캐시) |

⚠️ **절대 스킵 금지**: Validate 단계는 항상 실행해야 함

### 6. 반복 (Iterate)
`[GAPEVI:ITERATE] 시작` / `[GAPEVI:ITERATE] 완료` (또는 복귀 단계 명시)

**목적**: 검증 결과에 따른 개선

| 상황 | 복귀 단계 |
|------|----------|
| 타입 오류 | → 실행 (Execute) |
| 빌드 실패 | → 실행 (Execute) |
| 요구사항 변경 | → 분석 (Analyze) |
| 새 정보 발견 | → 수집 (Gather) |

**🚀 최적화 지침**:
| 최적화 | 적용 방법 |
|--------|----------|
| 최소 복귀 | 가능한 가장 가까운 단계로 복귀 (Gather 재시작 피함) |
| 부분 재실행 | 실패한 파일/테스트만 재처리 (전체 재실행 X) |
| 오류 분석 캐시 | 동일 오류 반복 시 이전 해결책 참조 |
| 빠른 피드백 | 단일 오류 수정 후 즉시 Validate (배치 수정 X) |

### 7. 완료 후 작업 (필수)

모든 작업 완료 후 **반드시** 다음 두 가지를 수행하세요:

#### 7.1 문서화 (필수)

작업 내용을 프로젝트 문서에 **반드시** 기록합니다:

| 문서 | 업데이트 내용 | 위치 |
|------|-------------|------|
| **CHANGELOG.md** | 변경 사항 기록 (Added/Fixed/Changed) | `docs/CHANGELOG.md` |
| **TODO.md** | 완료 항목 체크, 새 작업 추가 | `docs/TODO.md` |
| **ROADMAP.md** | 마일스톤 진행률 업데이트 (필요 시) | `docs/ROADMAP.md` |

**문서화 체크리스트**:
```markdown
- [ ] CHANGELOG.md에 변경 사항 추가
- [ ] TODO.md에서 완료 항목 체크 ([x])
- [ ] 새로 발견된 작업이 있으면 TODO.md에 추가
- [ ] 버전 마일스톤 완료 시 ROADMAP.md 업데이트
```

⚠️ **문서화 없이 작업 완료로 간주하지 않음**

#### 7.2 Next Step 제안

문서화 완료 후 다음 단계를 제안합니다:

```markdown
## Next Step 제안

### 📊 작업 완료 요약
| 항목 | 내용 |
|------|------|
| 작업 유형 | [새 기능 / 버그 수정 / 리팩토링] |
| 변경 파일 | [N개 파일] |
| Quality Gate | ✅ 통과 / ⚠️ 경고 / ❌ 실패 |
| 문서화 | ✅ 완료 (CHANGELOG, TODO 업데이트) |

### 🔧 추가 개선 사항
| 우선순위 | 항목 | 이유 |
|---------|------|------|
| 높음 | [개선 항목] | [필요한 이유] |
| 중간 | [개선 항목] | [필요한 이유] |

### ✅ 다음 액션 체크리스트
- [ ] 게임 실행 테스트
- [ ] 새 기능 동작 확인
```

---

## 명령어

### 명령어 조합 구조

GAPEVI 각 단계는 개별 명령어로 실행 가능하며, 상위 명령어가 이들을 조합합니다:

```
/new-feature, /bugfix (전체 GAPEVI 사이클)
        │
        ├─→ /gather     → 정보 수집
        ├─→ /analyze    → 분석 및 에이전트 선택
        ├─→ /prioritize → 작업 분해 및 순서 결정
        ├─→ /execute    → 구현 + 테스트 코드
        ├─→ /verify     → 품질 검증
        └─→ /iterate    → 문제 시 복귀
```

### GAPEVI 단계별 (개별 실행 가능)
- `/gather` - 수집: 정보/컨텍스트 수집
- `/analyze` - 분석: 영향 범위, 에이전트 선택
- `/prioritize` - 우선순위: 작업 분해, 실행 순서
- `/execute` - 실행: 코드 구현 + 테스트 작성
- `/verify` - 검증: Quality Gate 확인
- `/iterate` - 반복: 실패 시 해당 단계로 복귀

### 개발 (전체 GAPEVI 사이클)
- `/new-feature` - 새 기능 개발 (= /gather → /analyze → /prioritize → /execute → /verify)
- `/bugfix` - 버그 수정 (= /gather → /analyze → /execute → /verify)

### 부분 실행
- `/build` - 빌드 (tsc && vite build)
- `/dev` - 개발 서버 실행
- `/validate` - 타입 체크 및 빌드 검증 (빠른 확인)

### QA (품질 검증)
- `/qa` - 전체 QA 사이클 (자동화 + 수동 테스트 안내)
- `/qa-auto` - 자동화 테스트만 (단위 테스트 + 타입 체크 + 빌드)
- `/qa-manual` - 수동 체크리스트 표시
- `/qa-scenario [name]` - 특정 시나리오 테스트

### 메타 (Claude Code 설정)
- `/make-agent` - 에이전트/명령어/지식/규칙/훅 생성

### 에셋
- `/generate-sprite` - 스프라이트 생성 스크립트 실행
- `/generate-tileset` - 타일셋 생성

### 조합 사용 예시

```bash
# 전체 사이클 (권장)
/new-feature 레벨업 시스템 추가

# 단계별 수동 실행
/gather 레벨업 시스템
/analyze
/prioritize
/execute 1
/verify

# 부분 반복
/iterate execute   # 코드 수정 후 재실행
/verify            # 다시 검증
```

---

## 변경 이력

| 날짜 | 변경 | 담당자 |
|------|------|--------|
| 2026-02-03 | 문서화 필수 단계 추가 (CHANGELOG, TODO, ROADMAP 업데이트) | @claude |
| 2026-02-03 | 성능 최적화 전략 추가 (병렬 처리, 프리페치, 캐싱, 조건부 최적화, 파이프라인, 에이전트 최적화) | @claude |
| 2026-02-03 | GAPEVI 각 단계에 🚀 최적화 지침 추가 | @claude |
| 2026-02-03 | GAPEVI 단계별 명령어 추가 (/gather, /analyze, /prioritize, /execute, /verify, /iterate) | @claude |
| 2026-02-03 | Execute 단계에 테스트 코드 작성 필수 추가 | @claude |
| 2026-02-03 | Meta 시스템 추가 (/make-agent 명령어, Meta 에이전트, 템플릿) | @claude |
| 2026-02-03 | QA 시스템 추가 (에이전트, 명령어, 시나리오, Quality Gate 업데이트) | @claude |
| 2026-02-03 | IPE/GAPEVI 디버그 출력 추가 (시작/종료 지점) | @claude |
| 2026-02-03 | 트리거 판단 제거, 모든 요청에 YES/NO 확인 방식으로 변경 | @claude |
| 2026-02-03 | 프로젝트 추적 문서 참조 추가 (ROADMAP, TODO, CHANGELOG) | @claude |
| 2026-02-03 | 초기 생성 (blog.shaul.kr에서 마이그레이션) | @claude |
